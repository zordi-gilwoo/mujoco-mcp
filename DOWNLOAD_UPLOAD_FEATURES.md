# MuJoCo MCP Download/Upload Features

This document describes the new download and upload functionality added to the MuJoCo MCP server, which allows users to download XML files and Python scripts generated by prompts, upload custom content, and automatically render scenes.

## üÜï New MCP Tools

### 1. `download_xml` - Download XML Content
Download XML files generated from prompts or existing models.

**Parameters:**
- `model_id` (required): ID of the model to download XML from
- `include_resolved` (optional, default: true): Include resolved includes in the XML

**Example:**
```json
{
  "name": "download_xml",
  "arguments": {
    "model_id": "pendulum",
    "include_resolved": true
  }
}
```

**Returns:**
- Base64-encoded XML content
- Model type (built-in/menagerie)
- File metadata
- Download information

### 2. `download_python_script` - Generate Python Scripts
Generate downloadable Python scripts that recreate simulations.

**Parameters:**
- `model_id` (required): ID of the model to generate script for
- `include_viewer_setup` (optional, default: true): Include viewer setup code

**Example:**
```json
{
  "name": "download_python_script",
  "arguments": {
    "model_id": "pendulum",
    "include_viewer_setup": true
  }
}
```

**Returns:**
- Base64-encoded Python script
- Script metadata
- Auto-generated simulation code with viewer integration

### 3. `upload_xml` - Upload and Validate XML
Upload XML files with automatic validation and optional scene rendering.

**Parameters:**
- `xml_content` (required): XML content to upload and validate
- `scene_name` (optional): Name for the scene (auto-generated if not provided)
- `auto_render` (optional, default: true): Automatically render scene after validation

**Example:**
```json
{
  "name": "upload_xml",
  "arguments": {
    "xml_content": "<mujoco>...</mujoco>",
    "scene_name": "my_custom_scene",
    "auto_render": true
  }
}
```

**Features:**
- ‚úÖ Complete MuJoCo validation using model loading
- ‚úÖ Automatic scene rendering when viewer is available
- ‚úÖ File tracking with unique IDs
- ‚úÖ Comprehensive error reporting

### 4. `upload_python_script` - Upload Python Scripts
Upload Python scripts with safety validation.

**Parameters:**
- `script_content` (required): Python script content to upload
- `script_name` (optional): Name for the script (auto-generated if not provided)
- `safe_mode` (optional, default: true): Run safety checks with restricted operations

**Example:**
```json
{
  "name": "upload_python_script",
  "arguments": {
    "script_content": "import mujoco\n# Your code here",
    "script_name": "my_script.py",
    "safe_mode": true
  }
}
```

**Safety Features:**
- ‚úÖ Python syntax validation
- ‚úÖ Dangerous operation detection (subprocess, os.system, etc.)
- ‚úÖ Safe mode with restricted imports
- ‚úÖ File tracking and metadata

### 5. `list_uploaded_files` - File Management
List all uploaded files with filtering capabilities.

**Parameters:**
- `file_type` (optional): Filter by file type ("xml" or "python")

**Example:**
```json
{
  "name": "list_uploaded_files",
  "arguments": {
    "file_type": "xml"
  }
}
```

**Returns:**
- Complete file listing with metadata
- File sizes and timestamps
- Unique file IDs for tracking

## üîß Implementation Details

### FileHandler Class
The `FileHandler` class provides the core functionality:

```python
from mujoco_mcp.file_handler import FileHandler

fh = FileHandler()

# Validate XML
result = fh.validate_xml(xml_content)

# Generate Python script  
script = fh.generate_python_script(xml_content, scene_name, include_viewer=True)

# Save uploaded files
file_id = fh.save_upload_file(content, file_type, name)
```

### Validation Pipeline
1. **XML Validation:**
   - Basic XML structure validation
   - MuJoCo-specific requirements check
   - Full model loading validation
   - Detailed error reporting

2. **Python Script Validation:**
   - Syntax error checking
   - Dangerous operation detection
   - Safe mode restrictions
   - Import validation

### Auto-Rendering Workflow
1. Upload XML content
2. Validate against MuJoCo requirements
3. Create session if needed
4. Load model in viewer
5. Track model in session
6. Handle viewer connection failures gracefully

## üìä Usage Examples

### Complete Workflow Example
```python
import asyncio
from mujoco_mcp.mcp_server_menagerie import handle_call_tool

async def workflow_example():
    # 1. Download existing scene
    result = await handle_call_tool("download_xml", {"model_id": "pendulum"})
    
    # 2. Upload modified version
    modified_xml = "..."  # Your modifications
    result = await handle_call_tool("upload_xml", {
        "xml_content": modified_xml,
        "scene_name": "my_pendulum",
        "auto_render": True
    })
    
    # 3. Generate Python script
    result = await handle_call_tool("download_python_script", {
        "model_id": "my_pendulum"
    })
    
    # 4. List all files
    result = await handle_call_tool("list_uploaded_files", {})
```

### Error Handling Examples
```python
# Invalid XML upload
try:
    result = await handle_call_tool("upload_xml", {
        "xml_content": "<invalid>not mujoco</invalid>"
    })
    # Returns: ‚ùå XML validation failed: Not a valid MuJoCo XML
except Exception as e:
    print(f"Upload failed: {e}")

# Unsafe Python script
try:
    result = await handle_call_tool("upload_python_script", {
        "script_content": "import os\nos.system('rm -rf /')",
        "safe_mode": True
    })
    # Returns: ‚ùå Potentially dangerous operations found: os.system
except Exception as e:
    print(f"Upload failed: {e}")
```

## üîê Security Features

### Safe Mode for Python Scripts
- Detects dangerous imports: `subprocess`, `os.system`, `eval`, `exec`
- Prevents file system manipulation
- Restricts dynamic execution
- Provides clear error messages with suggestions

### XML Validation
- Complete MuJoCo model validation
- Prevents malformed XML injection
- Resource usage tracking
- Detailed validation reports

### File Management
- Unique file IDs prevent conflicts
- Timestamp tracking for auditing
- Type-based filtering
- Metadata preservation

## üß™ Testing

### Test Files Available
- `test_download_upload_features.py` - Comprehensive feature testing
- `test_auto_rendering.py` - Auto-rendering functionality tests
- `demo_download_upload_workflow.py` - End-to-end workflow demonstration
- `demo_complete_integration.py` - Full integration showcase

### Running Tests
```bash
# Basic feature tests
python test_download_upload_features.py

# Auto-rendering tests
python test_auto_rendering.py

# Complete workflow demo
python demo_download_upload_workflow.py

# Integration demo
python demo_complete_integration.py
```

## üéØ Real-World Applications

### Scene Prototyping
- Download base scenes
- Modify XML content
- Upload and validate changes
- Automatically render results

### Model Sharing
- Export scenes as downloadable files
- Share Python scripts for reproduction
- Validate shared content before loading
- Track file versions and metadata

### Educational Use
- Generate teaching materials
- Create reproducible examples
- Provide safe script environments
- Enable collaborative development

### Research Workflows
- Iterate on experimental setups
- Generate analysis scripts
- Share reproducible simulations
- Validate research models

## üöÄ Future Enhancements

Potential areas for expansion:
- Batch file operations
- Version control for uploaded files
- File sharing between sessions
- Integration with external storage
- Advanced script execution capabilities
- Model diff and merge tools

## üìã Summary

The new download/upload features provide a complete file management system for the MuJoCo MCP server, enabling:

‚úÖ **Seamless Content Exchange** - Download and upload XML/Python content with validation  
‚úÖ **Automatic Validation** - Complete MuJoCo model validation before rendering  
‚úÖ **Safety First** - Comprehensive safety checks for uploaded content  
‚úÖ **Auto-Rendering** - Automatic scene rendering with graceful error handling  
‚úÖ **File Management** - Complete file tracking and metadata management  
‚úÖ **Error Resilience** - Robust error handling and user feedback  

These features enable powerful workflows for scene development, model sharing, and collaborative simulation development while maintaining security and reliability.